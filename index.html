<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yamaguchi Halal Eats - Halal Food Delivery in Yamaguchi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }
        .hero-section {
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1512152272829-e3139592d56f?q=80&w=2940&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal, .auth-modal, .checkout-modal, .success-modal, .admin-modal {
            transition: opacity 0.3s ease;
        }
        .modal-content, .auth-modal-content, .checkout-modal-content, .success-modal-content, .admin-modal-content {
            transition: transform 0.3s ease;
        }
        .calendar-day.preorder-day { cursor: pointer; }
        .calendar-day.preorder-day:hover { background-color: #d1fae5; }
        .calendar-day.selected { outline: 2px solid #10b981; outline-offset: 2px; background-color: #a7f3d0; }
        .auth-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; text-align: center; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-green-600"><i class="fas fa-leaf mr-2"></i>Yamaguchi Halal Eats</div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-gray-600 hover:text-green-600">Home</a>
                <a href="#menu" class="text-gray-600 hover:text-green-600">Our Menu</a>
                <a href="#how-to-order" class="text-gray-600 hover:text-green-600">How to Order</a>
                <a href="#about" class="text-gray-600 hover:text-green-600">About Us</a>
                
                <!-- Auth buttons -->
                <div id="auth-links" class="flex items-center space-x-2">
                    <button id="login-button" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Log In</button>
                    <button id="signup-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Sign Up</button>
                </div>
                <div id="user-links" class="hidden items-center space-x-4">
                    <span id="welcome-message" class="font-semibold"></span>
                    <button id="account-button" class="text-gray-600 hover:text-green-600"><i class="fas fa-user-circle mr-1"></i>My Account</button>
                    <button id="logout-button" class="text-gray-600 hover:text-green-600"><i class="fas fa-sign-out-alt mr-1"></i>Log Out</button>
                </div>

                <button id="cart-button" class="relative text-gray-600 hover:text-green-600">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-3 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
            <div class="md:hidden flex items-center space-x-4">
                 <button id="mobile-cart-button" class="relative text-gray-600 hover:text-green-600">
                    <i class="fas fa-shopping-cart text-2xl"></i>
                    <span id="mobile-cart-count" class="absolute -top-2 -right-3 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <!-- Add a mobile menu button here if needed -->
            </div>
        </nav>
    </header>

    <!-- Content Sections (Hero, Calendar, Menu, How-to, About) -->
    <section class="hero-section text-white py-20 md:py-32"><div class="container mx-auto px-6 text-center"><h1 class="text-4xl md:text-6xl font-bold mb-4">Authentic Halal Cuisine, Delivered to Your Door.</h1><p class="text-lg md:text-xl mb-8">We deliver our original Halal dishes with care, anywhere in Yamaguchi Prefecture.</p><div class="max-w-2xl mx-auto"><div class="relative"><input id="search-bar" type="text" placeholder="Search for our dishes..." class="w-full py-4 px-6 rounded-full text-gray-800 focus:outline-none focus:ring-4 focus:ring-green-300"><button class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 text-white rounded-full px-6 py-3 hover:bg-green-700 transition"><i class="fas fa-search"></i></button></div></div></div></section>
    <section id="calendar-section" class="bg-white py-16"><div class="container mx-auto px-6"><h2 class="text-3xl font-bold text-center mb-4 text-gray-800">Pre-Order Calendar (July 2025)</h2><p class="text-center text-gray-600 mb-8">Click a date on the calendar to select a pre-order day.<br>Only residents of the listed city can pre-order on that day.</p><div class="max-w-3xl mx-auto bg-white p-4 sm:p-6 rounded-lg shadow-md"><div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div></div><div id="preorder-status" class="text-center mt-6 text-lg font-semibold text-green-700 h-8"></div></div></section>
    <main id="menu" class="container mx-auto px-6 py-16 pt-8"><h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Our Signature Menu</h2><div id="menu-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div></main>
    <section id="how-to-order" class="bg-white py-16"><div class="container mx-auto px-6 text-center"><h2 class="text-3xl font-bold text-center mb-12">How to Order</h2><div class="flex flex-col md:flex-row justify-center items-center space-y-8 md:space-y-0 md:space-x-12"><div class="text-center"><div class="bg-green-100 rounded-full h-24 w-24 flex items-center justify-center mx-auto mb-4"><i class="fas fa-mouse-pointer text-4xl text-green-600"></i></div><h3 class="text-xl font-bold mb-2">1. Choose</h3><p class="text-gray-600">Select your favorite dishes from our menu.</p></div><div class="text-center"><div class="bg-green-100 rounded-full h-24 w-24 flex items-center justify-center mx-auto mb-4"><i class="fas fa-shopping-cart text-4xl text-green-600"></i></div><h3 class="text-xl font-bold mb-2">2. Checkout</h3><p class="text-gray-600">Enter your details and confirm your order.</p></div><div class="text-center"><div class="bg-green-100 rounded-full h-24 w-24 flex items-center justify-center mx-auto mb-4"><i class="fas fa-motorcycle text-4xl text-green-600"></i></div><h3 class="text-xl font-bold mb-2">3. Enjoy</h3><p class="text-gray-600">Your delicious meal will be delivered to you.</p></div></div></div></section>
    <section id="about" class="bg-gray-100 py-16"><div class="container mx-auto px-6 text-center max-w-3xl"><h2 class="text-3xl font-bold text-center mb-4">About Us</h2><div class="text-center mb-8"><i class="fas fa-users text-4xl text-green-500"></i></div><h3 class="text-2xl font-semibold text-gray-800 mb-4">Our History</h3><p class="text-gray-600 leading-relaxed">This service was started by a Japanese and an Indonesian living together in Yamaguchi Prefecture. Our mission is to deliver authentic, delicious, and worry-free Halal meals to everyone who needs them in our community. We pour our hearts into every dish, hoping to bring you the comforting taste of home.</p></div></section>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8"><div class="container mx-auto px-6 text-center"><p class="mb-4">&copy; 2025 Yamaguchi Halal Eats. All Rights Reserved.</p><button id="admin-panel-button" class="text-sm text-gray-400 hover:text-white underline">Admin Panel</button></div></footer>

    <!-- Modals -->
    <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-lg z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">Shopping Cart</h3><button id="close-cart-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="cart-items" class="p-6 overflow-y-auto flex-grow"><p id="empty-cart-message" class="text-gray-500">Your cart is empty.</p></div><div class="p-6 border-t bg-gray-50"><div class="flex justify-between items-center mb-4"><span class="text-lg font-medium">Total:</span><span id="cart-total" class="text-2xl font-bold">¥0</span></div><button id="checkout-button" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition disabled:bg-gray-400">Checkout</button></div></div>
    <div id="checkout-modal" class="checkout-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden"><div id="checkout-modal-content" class="checkout-modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">Confirm Your Order</h3><button id="close-checkout-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="checkout-form" class="p-6 overflow-y-auto" novalidate><h4 class="text-lg font-semibold mb-4">Your Information</h4><div class="space-y-4"><div><label for="customer-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="customer-name" name="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div><div><label for="customer-phone" class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" id="customer-phone" name="phone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div><div><label for="customer-email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="customer-email" name="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" readonly></div><div><label for="customer-address" class="block text-sm font-medium text-gray-700">Delivery Address</label><textarea id="customer-address" name="address" rows="3" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea></div></div><div id="form-error" class="text-red-500 text-sm mt-4 hidden">Please fill in all fields.</div><div class="mt-6 border-t pt-4"><div class="flex justify-between items-center text-lg"><span>Total Payment:</span><span id="checkout-total" class="font-bold text-xl"></span></div></div></form><div class="p-6 bg-gray-50 border-t"><button type="submit" id="confirm-order-button" form="checkout-form" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition disabled:opacity-75">Confirm Order</button></div></div></div>
    <div id="success-modal" class="success-modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm text-center p-8"><div class="text-green-500 mb-4"><i class="fas fa-check-circle fa-4x"></i></div><h3 class="text-2xl font-bold mb-2">Thank You for Your Order!</h3><p class="text-gray-600 mb-6">Your order has been successfully placed.</p><button id="close-success-modal-button" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">Close</button></div></div>
    <div id="admin-modal" class="admin-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden"><div class="admin-modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col transform scale-95"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">Order Management Panel</h3><button id="close-admin-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="order-list" class="p-6 overflow-y-auto bg-gray-100 flex-grow"><p class="text-center text-gray-500">No orders yet.</p></div></div></div>

    <!-- Auth Modals (Sign Up, Log In, My Account) -->
    <div id="signup-modal" class="auth-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden"><div class="auth-modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">Create Your Account</h3><button id="close-signup-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="signup-form" class="p-6 space-y-4" novalidate><div><label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="signup-name" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div><label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required minlength="6" class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div id="signup-error" class="auth-error hidden"></div><div class="pt-2"><button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">Sign Up</button></div></form></div></div>
    <div id="login-modal" class="auth-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden"><div class="auth-modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">Log In to Your Account</h3><button id="close-login-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="login-form" class="p-6 space-y-4" novalidate><div><label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div id="login-error" class="auth-error hidden"></div><div class="pt-2"><button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">Log In</button></div></form></div></div>
    <div id="account-modal" class="auth-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden"><div class="auth-modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">My Account</h3><button id="close-account-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="account-form" class="p-6 space-y-4" novalidate><div><label for="account-name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="account-name" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div><label for="account-phone" class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" id="account-phone" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div><div><label for="account-address" class="block text-sm font-medium text-gray-700">Delivery Address</label><textarea id="account-address" rows="3" required class="mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></textarea></div><div id="account-success" class="text-green-600 text-sm mt-2 text-center hidden">Profile updated successfully!</div><div id="account-error" class="auth-error hidden"></div><div class="pt-2"><button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">Save Changes</button></div></form></div></div>

    <script type="module">
    // Firebase SDK Import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyBVH-Wr8v--A0uSn8Z82fFLdn_v6SZoT8Y",
        authDomain: "yamaguchi-halal-eats.firebaseapp.com",
        projectId: "yamaguchi-halal-eats",
        storageBucket: "yamaguchi-halal-eats.appspot.com",
        messagingSenderId: "471358397224",
        appId: "1:471358397224:web:46184a676f2b9b23860e1d",
        measurementId: "G-XKK7QMMWWN"
    };

    let db, auth;
    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
      try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
      } catch (e) { console.error("Error initializing Firebase:", e); }
    }

    const menuItems = [ { id: 1, name: "Halal Tonkotsu Ramen", category: "Japanese", price: 1250, description: "Our signature ramen with a rich, creamy pork-free broth, topped with chicken chashu, menma, and a seasoned egg.", imageUrl: "https://images.unsplash.com/photo-1612927601601-6638424737ce?q=80&w=2787&auto=format&fit=crop" }, { id: 2, name: "Nasi Goreng", category: "Indonesian", price: 1100, description: "Classic Indonesian fried rice with sweet soy sauce, chicken, and a fried egg on top.", imageUrl: "https://images.unsplash.com/photo-1599602235011-95b62a773f77?q=80&w=2849&auto=format&fit=crop" }, { id: 3, name: "Chicken Satay (5 Skewers)", category: "Indonesian", price: 800, description: "Tender, marinated chicken skewers, grilled to perfection and served with a rich peanut sauce.", imageUrl: "https://images.unsplash.com/photo-1626084469318-26122a751593?q=80&w=2940&auto=format&fit=crop" }, { id: 4, name: "Beef Rendang", category: "Indonesian", price: 1600, description: "Slow-cooked beef in a fragrant mixture of coconut milk and spices until tender and flavorful.", imageUrl: "https://images.unsplash.com/photo-1626084474384-5893557a5fb2?q=80&w=2940&auto=format&fit=crop" }, { id: 5, name: "Halal Gyoza (6 pcs)", category: "Japanese", price: 650, description: "Pan-fried dumplings filled with minced chicken and vegetables, served with a soy-vinegar dipping sauce.", imageUrl: "https://images.unsplash.com/photo-1631783321568-9a35622fa22b?q=80&w=2787&auto=format&fit=crop" }, { id: 6, name: "Mango Lassi", category: "Drink", price: 500, description: "A refreshing and creamy yogurt drink blended with sweet, ripe mangoes.", imageUrl: "https://images.unsplash.com/photo-1626803364123-0176e053d231?q=80&w=2787&auto=format&fit=crop" } ];
    let cart = [];
    let selectedPreOrder = { date: null, city: null };
    let currentUser = null;

    // --- DOM Elements ---
    const menuList = document.getElementById('menu-list'); const searchBar = document.getElementById('search-bar'); const calendarGrid = document.getElementById('calendar-grid'); const preorderStatus = document.getElementById('preorder-status'); const cartButton = document.getElementById('cart-button'); const mobileCartButton = document.getElementById('mobile-cart-button'); const cartSidebar = document.getElementById('cart-sidebar'); const closeCartButton = document.getElementById('close-cart-button'); const cartItemsContainer = document.getElementById('cart-items'); const cartTotalElement = document.getElementById('cart-total'); const cartCountElements = [document.getElementById('cart-count'), document.getElementById('mobile-cart-count')]; const emptyCartMessage = document.getElementById('empty-cart-message'); const checkoutButton = document.getElementById('checkout-button'); const checkoutModal = document.getElementById('checkout-modal'); const closeCheckoutModalButton = document.getElementById('close-checkout-modal-button'); const checkoutForm = document.getElementById('checkout-form'); const checkoutTotalElement = document.getElementById('checkout-total'); const formError = document.getElementById('form-error'); const successModal = document.getElementById('success-modal'); const closeSuccessModalButton = document.getElementById('close-success-modal-button'); const adminPanelButton = document.getElementById('admin-panel-button'); const adminModal = document.getElementById('admin-modal'); const closeAdminModalButton = document.getElementById('close-admin-modal-button'); const orderListContainer = document.getElementById('order-list');
    // Auth UI elements
    const authLinks = document.getElementById('auth-links'); const userLinks = document.getElementById('user-links'); const welcomeMessage = document.getElementById('welcome-message'); const signupModal = document.getElementById('signup-modal'); const loginModal = document.getElementById('login-modal'); const accountModal = document.getElementById('account-modal');

    // --- Functions ---
    const showAuthError = (modal, message) => { const errorEl = document.getElementById(`${modal}-error`); errorEl.textContent = message; errorEl.classList.remove('hidden'); };
    const closeAuthModal = (modalId) => { const modal = document.getElementById(modalId); modal.classList.add('hidden'); modal.querySelector('.auth-modal-content').classList.add('scale-95'); document.body.style.overflow = 'auto'; };
    const openAuthModal = (modalId) => { const modal = document.getElementById(modalId); modal.classList.remove('hidden'); setTimeout(() => modal.querySelector('.auth-modal-content').classList.remove('scale-95'), 10); document.body.style.overflow = 'hidden'; };
    
    function generateCalendar(year, month) { calendarGrid.innerHTML = ''; const monthIndex = month - 1; const firstDay = new Date(year, monthIndex, 1).getDay(); const daysInMonth = new Date(year, month, 0).getDate(); const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; weekDays.forEach(day => { const dayHeader = document.createElement('div'); dayHeader.className = 'font-bold text-gray-700 p-2'; dayHeader.textContent = day; calendarGrid.appendChild(dayHeader); }); for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); } for (let day = 1; day <= daysInMonth; day++) { const dayCell = document.createElement('div'); const date = new Date(year, monthIndex, day); const dayOfWeek = date.getDay(); dayCell.className = 'calendar-day p-2 rounded-lg border border-gray-200 flex flex-col justify-between h-24 sm:h-28'; let contentHTML = `<span class="font-bold">${day}</span>`; let city = null; if (dayOfWeek === 6) { dayCell.classList.add('bg-blue-50', 'preorder-day'); city = 'Yamaguchi City'; contentHTML += `<span class="text-sm font-semibold text-blue-700 mt-auto">${city}</span>`; } else if (dayOfWeek === 0) { dayCell.classList.add('bg-red-50', 'preorder-day'); city = 'Ube City'; contentHTML += `<span class="text-sm font-semibold text-red-700 mt-auto">${city}</span>`; } else { dayCell.classList.add('bg-gray-50'); } dayCell.innerHTML = contentHTML; if (city) { dayCell.addEventListener('click', () => { document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected')); dayCell.classList.add('selected'); const dateString = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric' }).format(date); selectedPreOrder = { date: dateString, city: city }; preorderStatus.textContent = `Delivery for ${selectedPreOrder.date} is available for residents of ${selectedPreOrder.city}. Please proceed with your order.`; }); } calendarGrid.appendChild(dayCell); } }
    function renderMenu(items) { menuList.innerHTML = ''; if (items.length === 0) { menuList.innerHTML = `<p class="text-gray-600 col-span-full text-center">No matching dishes found.</p>`; return; } items.forEach(item => { const card = document.createElement('div'); card.className = 'menu-card bg-white rounded-lg shadow-md overflow-hidden flex flex-col'; card.innerHTML = `<div class="h-48 overflow-hidden"><img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover"></div><div class="p-4 flex flex-col flex-grow"><h3 class="text-xl font-bold mb-2">${item.name}</h3><p class="text-gray-600 mb-4 text-sm flex-grow">${item.description}</p><div class="flex justify-between items-center mt-auto"><p class="text-lg font-bold text-green-600">¥${item.price.toLocaleString()}</p><button data-item-id="${item.id}" class="add-to-cart-button bg-green-100 text-green-700 font-semibold px-4 py-2 rounded-lg hover:bg-green-200 transition"><i class="fas fa-plus mr-2"></i>Add</button></div></div>`; menuList.appendChild(card); }); }
    function addToCart(e) { const button = e.target.closest('.add-to-cart-button'); if (!button) return; const itemId = parseInt(button.dataset.itemId); const menuItem = menuItems.find(m => m.id === itemId); const existingCartItem = cart.find(item => item.id === itemId); if (existingCartItem) { existingCartItem.quantity++; } else { cart.push({ ...menuItem, quantity: 1 }); } updateCart(); button.innerHTML = '<i class="fas fa-check"></i>Added'; button.classList.add("bg-green-500", "text-white"); setTimeout(() => { button.innerHTML = '<i class="fas fa-plus mr-2"></i>Add'; button.classList.remove("bg-green-500", "text-white"); }, 1500); }
    function updateCart() { if (cart.length === 0) { cartItemsContainer.innerHTML = ''; emptyCartMessage.classList.remove('hidden'); } else { emptyCartMessage.classList.add('hidden'); cartItemsContainer.innerHTML = ''; cart.forEach(t => { const e = document.createElement('div'); e.className = 'flex justify-between items-center py-3 border-b'; e.innerHTML = `<div class="flex-grow"><p class="font-semibold">${t.name}</p><p class="text-sm text-gray-600">¥${t.price.toLocaleString()}</p></div><div class="flex items-center space-x-3"><button class="quantity-change-button text-gray-500" data-item-id="${t.id}" data-change="-1">-</button><span>${t.quantity}</span><button class="quantity-change-button text-gray-500" data-item-id="${t.id}" data-change="1">+</button></div><p class="w-20 text-right font-semibold">¥${(t.price * t.quantity).toLocaleString()}</p>`; cartItemsContainer.appendChild(e); }); } const t = cart.reduce((t, e) => t + e.price * e.quantity, 0); cartTotalElement.textContent = `¥${t.toLocaleString()}`; const e = cart.reduce((t, e) => t + e.quantity, 0); cartCountElements.forEach(t => { t.textContent = e; t.classList.toggle('hidden', e === 0); }); checkoutButton.disabled = cart.length === 0; }
    function handleQuantityChange(e) { const t = e.target.closest('.quantity-change-button'); if (!t) return; const a = parseInt(t.dataset.itemId), n = parseInt(t.dataset.change), s = cart.findIndex(t => t.id === a); s > -1 && (cart[s].quantity += n, cart[s].quantity <= 0 && cart.splice(s, 1)); updateCart(); }
    function openCart() { cartSidebar.classList.remove('translate-x-full'); }
    function closeCart() { cartSidebar.classList.add('translate-x-full'); }
    async function openCheckoutModal() { const total = cart.reduce((t, e) => t + e.price * e.quantity, 0); checkoutTotalElement.textContent = `¥${total.toLocaleString()}`; if (currentUser) { const userDoc = await getDoc(doc(db, "users", currentUser.uid)); if (userDoc.exists()) { const userData = userDoc.data(); document.getElementById('customer-name').value = userData.name || ''; document.getElementById('customer-phone').value = userData.phone || ''; document.getElementById('customer-address').value = userData.address || ''; } document.getElementById('customer-email').value = currentUser.email; } else { checkoutForm.reset(); } checkoutModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; setTimeout(() => document.getElementById('checkout-modal-content').classList.remove('scale-95'), 10); }
    function closeCheckoutModal() { document.getElementById('checkout-modal-content').classList.add('scale-95'); checkoutModal.classList.add('hidden'); document.body.style.overflow = 'auto'; formError.classList.add('hidden'); }
    async function handleOrderSubmit(e) { e.preventDefault(); const confirmButton = document.getElementById('confirm-order-button'); if (!checkoutForm.checkValidity()) { formError.classList.remove('hidden'); return; } formError.classList.add('hidden'); const originalButtonText = confirmButton.innerHTML; confirmButton.disabled = true; confirmButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Loading...`; if (!db) { alert("Database connection error."); confirmButton.disabled = false; confirmButton.innerHTML = originalButtonText; return; } const formData = new FormData(checkoutForm); const customerDetails = Object.fromEntries(formData.entries()); const orderItems = cart.map(item => ({ name: item.name, quantity: item.quantity, price: item.price })); const orderTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0); const orderData = { customerInfo: customerDetails, items: orderItems, total: orderTotal, createdAt: serverTimestamp(), userId: currentUser ? currentUser.uid : 'guest' }; if (selectedPreOrder.date) { orderData.preOrderInfo = selectedPreOrder; } try { const saveDataPromise = addDoc(collection(db, "orders"), orderData); const minDelayPromise = new Promise(resolve => setTimeout(resolve, 2000)); await Promise.all([saveDataPromise, minDelayPromise]); closeCheckoutModal(); showSuccessModal(); closeCart(); cart = []; selectedPreOrder = { date: null, city: null }; preorderStatus.textContent = ''; document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected')); updateCart(); checkoutForm.reset(); } catch (err) { console.error("Error saving order: ", err); alert("An error occurred while processing your order."); } finally { confirmButton.disabled = false; confirmButton.innerHTML = originalButtonText; } }
    function showSuccessModal() { successModal.classList.remove('hidden'); }
    function closeSuccessModal() { successModal.classList.add('hidden'); }
    function openAdminPanel() { const t = prompt("Enter admin password:"); if (t === "admin123") { if (!db) { alert("Database connection error."); return; } adminModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; loadOrders(); } else if (t) { alert("Incorrect password."); } }
    function closeAdminPanel() { adminModal.classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function loadOrders() { if (!db) return; const t = query(collection(db, "orders"), orderBy("createdAt", "desc")); onSnapshot(t, t => { if (t.empty) { orderListContainer.innerHTML = '<p class="text-center text-gray-500">No orders yet.</p>'; return; } orderListContainer.innerHTML = ''; t.forEach(t => { const e = t.data(), a = document.createElement('div'); a.className = "bg-white p-4 rounded-lg shadow mb-4"; const n = e.items.map(t => `<li>${t.name} (x${t.quantity}) - ¥${(t.price * t.quantity).toLocaleString()}</li>`).join(''); let s = ''; e.preOrderInfo && (s = `<div class="mt-2 p-2 bg-green-100 rounded-md"><p class="font-semibold text-green-800">Pre-Order: ${e.preOrderInfo.date} (for ${e.preOrderInfo.city})</p></div>`); a.innerHTML = ` <div class="flex justify-between items-start"> <div> <p class="font-bold text-lg">Order ID: ${t.id}</p> <p class="text-sm text-gray-500">Date: ${e.createdAt ? e.createdAt.toDate().toLocaleString("en-US") : 'N/A'}</p> </div> <p class="font-bold text-xl text-green-600">Total: ¥${e.total.toLocaleString()}</p> </div> ${s} <div class="mt-4 border-t pt-4"> <h4 class="font-semibold">Customer Info:</h4> <p><strong>Name:</strong> ${e.customerInfo.name}</p> <p><strong>Phone:</strong> ${e.customerInfo.phone}</p> <p><strong>Email:</strong> ${e.customerInfo.email}</p> <p><strong>Address:</strong> ${e.customerInfo.address}</p> </div> <div class="mt-4 border-t pt-4"> <h4 class="font-semibold">Order Details:</h4> <ul class="list-disc list-inside">${n}</ul> </div> `; orderListContainer.appendChild(a); }); }); }
    function filterMenu() { const query = searchBar.value.toLowerCase(); const filtered = menuItems.filter(item => item.name.toLowerCase().includes(query) || item.description.toLowerCase().includes(query)); renderMenu(filtered); }

    // --- Auth Listeners & Functions ---
    if(auth) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userName = userDoc.exists() ? userDoc.data().name.split(' ')[0] : 'User';
                welcomeMessage.textContent = `Welcome, ${userName}!`;
                authLinks.classList.add('hidden');
                userLinks.classList.remove('hidden');
            } else {
                currentUser = null;
                authLinks.classList.remove('hidden');
                userLinks.classList.add('hidden');
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => { e.preventDefault(); const name = e.target['signup-name'].value; const email = e.target['signup-email'].value; const password = e.target['signup-password'].value; try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); await setDoc(doc(db, "users", userCredential.user.uid), { name: name, email: email, phone: '', address: '' }); closeAuthModal('signup-modal'); } catch (error) { showAuthError('signup', error.message); } });
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = e.target['login-email'].value; const password = e.target['login-password'].value; try { await signInWithEmailAndPassword(auth, email, password); closeAuthModal('login-modal'); } catch (error) { showAuthError('login', error.message); } });
        document.getElementById('logout-button').addEventListener('click', () => { signOut(auth); });
        document.getElementById('account-form').addEventListener('submit', async (e) => { e.preventDefault(); if (!currentUser) return; const name = e.target['account-name'].value; const phone = e.target['account-phone'].value; const address = e.target['account-address'].value; try { await setDoc(doc(db, "users", currentUser.uid), { name, phone, address }, { merge: true }); const successMsg = document.getElementById('account-success'); successMsg.classList.remove('hidden'); setTimeout(() => successMsg.classList.add('hidden'), 3000); } catch (error) { showAuthError('account', error.message); } });
        document.getElementById('account-button').addEventListener('click', async () => { if (!currentUser) return; const userDoc = await getDoc(doc(db, "users", currentUser.uid)); if (userDoc.exists()) { const data = userDoc.data(); document.getElementById('account-name').value = data.name || ''; document.getElementById('account-phone').value = data.phone || ''; document.getElementById('account-address').value = data.address || ''; } openAuthModal('account-modal'); });
    }

    // --- General Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => { generateCalendar(2025, 7); renderMenu(menuItems); cartCountElements.forEach(t => t.classList.add('hidden')); });
    menuList.addEventListener('click', addToCart);
    document.getElementById('signup-button').addEventListener('click', () => openAuthModal('signup-modal')); document.getElementById('close-signup-modal-button').addEventListener('click', () => closeAuthModal('signup-modal'));
    document.getElementById('login-button').addEventListener('click', () => openAuthModal('login-modal')); document.getElementById('close-login-modal-button').addEventListener('click', () => closeAuthModal('login-modal'));
    document.getElementById('close-account-modal-button').addEventListener('click', () => closeAuthModal('account-modal'));
    closeCheckoutModalButton.addEventListener('click', closeCheckoutModal); checkoutModal.addEventListener('click', e => e.target === checkoutModal && closeCheckoutModal());
    closeSuccessModalButton.addEventListener('click', closeSuccessModal);
    cartButton.addEventListener('click', openCart); mobileCartButton.addEventListener('click', openCart); closeCartButton.addEventListener('click', closeCart);
    cartItemsContainer.addEventListener('click', handleQuantityChange);
    checkoutButton.addEventListener('click', openCheckoutModal);
    checkoutForm.addEventListener('submit', handleOrderSubmit);
    searchBar.addEventListener('input', filterMenu);
    adminPanelButton.addEventListener('click', openAdminPanel);
    closeAdminModalButton.addEventListener('click', closeAdminPanel);
    </script>
</body>
</html>
